<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>بوابة صلالة الشرقية الرقمية | النسخة المطورة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --deep-green: #061f1c;
            --gold-primary: #c5a059;
            --gold-soft: #e3c08d;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --text: #e0e6e6;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
        }

        body {
            font-family: 'Almarai', sans-serif;
            margin: 0;
            background: var(--deep-green);
            background-image: radial-gradient(circle at 10% 20%, rgba(10, 61, 52, 1) 0%, #061f1c 90%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        header { padding: 25px 8%; border-bottom: 1px solid var(--border); backdrop-filter: blur(15px); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 950px; margin: 40px auto; padding: 20px; }

        /* --- تحسين بطاقة الطالب --- */
        .student-id-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.03) 100%);
            border-radius: 20px; padding: 30px; border: 1px solid var(--border);
            display: flex; align-items: center; gap: 30px; position: relative; margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .avatar-box {
            width: 100px; height: 100px; border-radius: 50%; background: var(--gold-primary);
            display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--deep-green);
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.3);
        }

        /* --- مؤشر المعدل العام --- */
        .avg-circle {
            text-align: center; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; border: 1px solid var(--gold-primary);
        }

        /* --- جدول النتائج --- */
        .results-wrapper { background: var(--glass); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(197, 160, 89, 0.15); padding: 18px; text-align: right; color: var(--gold-soft); font-weight: 800; }
        td { padding: 16px; border-bottom: 1px solid var(--border); transition: 0.3s; }
        tr:hover td { background: rgba(255,255,255,0.03); }

        .grade-pill {
            padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
        }

        /* --- الأزرار --- */
        .btn-premium {
            background: linear-gradient(135deg, #c5a059, #8e6d2e); color: #061f1c;
            padding: 14px 30px; border-radius: 12px; border: none; font-weight: 800;
            cursor: pointer; transition: 0.4s; font-size: 1rem; display: flex; align-items: center; gap: 10px;
        }
        .btn-premium:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(197, 160, 89, 0.3); }

        /* --- الانيميشن --- */
        #loader { display: none; margin: 20px auto; width: 50px; height: 50px; border: 5px solid var(--glass); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .view { display: none; opacity: 0; transform: translateY(20px); transition: 0.5s; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        /* طباعة */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .student-id-card { border: 2px solid #000 !important; color: black !important; }
            th { background: #eee !important; color: black !important; border: 1px solid #000; }
            td { border: 1px solid #000; color: black !important; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: auto;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-graduation-cap" style="font-size: 2rem; color: var(--gold-primary);"></i>
            <h1 style="color: var(--gold-soft); font-size: 1.4rem; margin: 0;">بوابة صلالة الشرقية الرقمية</h1>
        </div>
        <div style="font-size: 0.9rem; opacity: 0.8;">النظام الأكاديمي الموحد</div>
    </div>
</header>

<div class="container">
    
    <section id="searchView" class="view active no-print">
        <div style="background: var(--glass); padding: 60px 20px; border-radius: 30px; text-align: center; border: 1px solid var(--border);">
            <h2 style="margin-bottom: 10px; font-size: 2rem;">مرحباً بك</h2>
            <p style="color: var(--gold-soft); margin-bottom: 35px;">الرجاء إدخال الرقم المدني للطالب للاستعلام عن النتائج</p>
            
            <div style="position: relative; max-width: 400px; margin: auto;">
                <input type="number" id="civilInput" placeholder="أدخل الرقم المدني المكون من 8 أرقام" 
                       style="width: 100%; padding: 18px; border-radius: 15px; border: 1px solid var(--border); background: rgba(0,0,0,0.4); color: white; text-align: center; font-size: 1.3rem; outline: none;">
            </div>

            <div id="loader"></div>

            <div class="btn-group" style="margin-top: 30px; display: flex; justify-content: center;">
                <button class="btn-premium" onclick="processSearch()">
                    <i class="fa-solid fa-magnifying-glass"></i> عرض السجل الأكاديمي
                </button>
            </div>
        </div>
    </section>

    <section id="resultView" class="view">
        <div id="printHeader" style="display:none;" class="print-only">
             <center><h3>سلطنة عمان - وزارة التربية والتعليم</h3><h4>مدرسة صلالة الشرقية (5-10)</h4></center>
             <hr>
        </div>

        <div class="student-id-card">
            <div class="avatar-box no-print"><i class="fa-solid fa-user-graduate"></i></div>
            <div style="flex-grow: 1;">
                <h2 id="stName" style="margin: 0; font-size: 1.8rem; color: var(--gold-soft);">...</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <span><i class="fa-solid fa-id-card"></i> المدني: <b id="stCivil"></b></span>
                    <span><i class="fa-solid fa-layer-group"></i> الصف: <b id="stGrade"></b></span>
                    <span><i class="fa-solid fa-door-open"></i> الشعبة: <b id="stClass"></b></span>
                    <span style="color: var(--gold-primary);"><i class="fa-solid fa-chart-line"></i> الحالة: <b>ناجح</b></span>
                </div>
            </div>
            <div class="avg-circle">
                <div style="font-size: 0.8rem; margin-bottom: 5px;">المعدل العام</div>
                <div id="stAvg" style="font-size: 1.8rem; font-weight: 900; color: var(--gold-soft);">0%</div>
            </div>
        </div>

        <div class="results-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>المادة الدراسية</th>
                        <th style="text-align: center;">الدرجة</th>
                        <th style="text-align: center;">التقدير</th>
                    </tr>
                </thead>
                <tbody id="tableContent"></tbody>
            </table>
        </div>

        <div class="btn-group no-print" style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
            <button class="btn-premium" onclick="window.print()">
                <i class="fa-solid fa-print"></i> طباعة الشهادة
            </button>
            <button class="btn-premium" onclick="location.reload()" style="background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border);">
                <i class="fa-solid fa-arrow-right-rotate"></i> بحث آخر
            </button>
        </div>
    </section>
</div>

<script>
    async function processSearch() {
        const civil = document.getElementById('civilInput').value.trim();
        if(!civil) return alert("يرجى إدخال الرقم المدني");

        // إظهار لودر التحميل
        document.getElementById('loader').style.display = 'block';
        
        const files = ["grade5.json", "grade6.json", "grade7.json", "grade8.json", "grade9.json"];
        let found = null;

        try {
            for(let f of files) {
                const res = await fetch(f + "?v=" + Date.now());
                if (!res.ok) continue;
                const data = await res.json();
                found = data.find(s => s["رقم_مدني"].toString() === civil);
                if(found) break;
            }
        } catch (error) {
            console.error("خطأ في جلب البيانات", error);
        }

        document.getElementById('loader').style.display = 'none';

        if(found) {
            renderResult(found);
        } else {
            alert("عذراً، لم يتم العثور على بيانات لهذا الرقم المدني. تأكد من صحة الرقم.");
        }
    }

    function renderResult(data) {
        const excludedKeys = ["رقم_مدني", "الاسم", "الصف", "الشعبة"];
        const subjectKeys = Object.keys(data).filter(k => !excludedKeys.includes(k));
        
        let total = 0;
        let count = 0;
        let rows = '';

        subjectKeys.forEach(k => {
            const val = parseFloat(data[k]) || 0;
            total += val;
            count++;

            // نظام الألوان والتقديرات
            let color = '';
            let label = '';
            if(val >= 90) { color = 'var(--success)'; label = 'ممتاز'; }
            else if(val >= 80) { color = '#3498db'; label = 'جيد جداً'; }
            else if(val >= 65) { color = 'var(--warning)'; label = 'جيد'; }
            else if(val >= 50) { color = '#e67e22'; label = 'مقبول'; }
            else { color = 'var(--danger)'; label = 'ضعيف'; }

            rows += `
                <tr>
                    <td style="font-weight: bold;">${k}</td>
                    <td style="text-align: center; font-size: 1.2rem; font-weight: 800; color: ${color}">${val}</td>
                    <td style="text-align: center;">
                        <span class="grade-pill" style="background: ${color}22; color: ${color}; border: 1px solid ${color}">
                            ${label}
                        </span>
                    </td>
                </tr>
            `;
        });

        const avg = (total / count).toFixed(1);
        
        document.getElementById('stName').innerText = data["الاسم"];
        document.getElementById('stCivil').innerText = data["رقم_مدني"];
        document.getElementById('stGrade').innerText = data["الصف"];
        document.getElementById('stClass').innerText = data["الشعبة"];
        document.getElementById('stAvg').innerText = avg + "%";
        document.getElementById('tableContent').innerHTML = rows;

        // التبديل بين الواجهات
        document.getElementById('searchView').classList.remove('active');
        setTimeout(() => {
            document.getElementById('searchView').style.display = 'none';
            document.getElementById('resultView').classList.add('active');
        }, 300);
    }
</script>

</body>
</html>
