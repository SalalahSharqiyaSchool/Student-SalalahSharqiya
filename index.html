<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام النتائج الرسمي | مدرسة صلالة الشرقية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root { --emerald: #04241f; --gold: #af9164; --bg: #f4f7f6; }
        
        body { font-family: 'Almarai', sans-serif; background: var(--emerald); margin: 0; padding: 0; color: #fff; }
        .no-print { display: block; }

        /* حاوية الإدخال */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { 
            background: rgba(255,255,255,0.08); backdrop-filter: blur(15px);
            padding: 40px; border-radius: 30px; border: 1px solid var(--gold);
            text-align: center; width: 100%; max-width: 400px;
        }

        .input-style {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--gold);
            background: #fff; color: #333; font-size: 1.2rem; text-align: center; margin: 20px 0; box-sizing: border-box;
        }

        .btn-submit {
            background: var(--gold); color: white; border: none; padding: 15px 30px;
            border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; font-size: 1.1rem;
        }

        /* حاوية النتائج والطباعة */
        #resultPage { display: none; background: var(--bg); color: #333; min-height: 100vh; padding: 20px 10px; }
        
        .a4-container {
            background: #fff; max-width: 800px; margin: 0 auto; padding: 30px;
            border: 10px double var(--gold); position: relative; box-sizing: border-box;
        }

        .header-table { width: 100%; border-bottom: 3px solid var(--emerald); margin-bottom: 20px; padding-bottom: 10px; }
        
        .student-info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            background: #eee; padding: 15px; border-radius: 10px; margin-bottom: 20px;
        }

        .main-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .main-table th { background: var(--emerald); color: white; padding: 12px; font-size: 0.9rem; }
        .main-table td { border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: 700; }

        /* بطاقة الأوائل المدمجة */
        .tops-card {
            background: #fffbe6; border: 1px solid #ffe58f; padding: 15px;
            border-radius: 10px; margin: 20px 0; text-align: center;
        }

        /* المحلل الذكي المدمج */
        .ai-box {
            background: #f0f5ff; border: 2px dashed #adc6ff; padding: 15px;
            border-radius: 10px; margin-top: 20px; display: flex; align-items: flex-start; gap: 10px;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            #resultPage { display: block !important; padding: 0; }
            .a4-container { border-width: 5px; box-shadow: none; width: 100%; max-width: none; }
            @page { size: A4; margin: 1cm; }
        }

        @media (max-width: 600px) {
            .student-info-grid { grid-template-columns: 1fr; }
            .a4-container { padding: 15px; }
        }
    </style>
</head>
<body>

<div id="loginSection" class="login-container no-print">
    <div class="login-card">
        <i class="fa-solid fa-user-shield" style="font-size: 3rem; color: var(--gold);"></i>
        <h2>بوابة النتائج الرسمية</h2>
        <p style="font-size: 0.8rem; opacity: 0.8;">مدرسة صلالة الشرقية (5-10)</p>
        <input type="text" id="civilId" class="input-style" placeholder="أدخل الرقم المدني">
        <button class="btn-submit" onclick="startProcess()">عرض الشهادة الآن</button>
    </div>
</div>

<div id="resultPage">
    <div class="a4-container">
        <table class="header-table">
            <tr>
                <td style="width:33%; font-size:0.75rem;">سلطنة عمان<br>وزارة التربية والتعليم<br><b>مدرسة صلالة الشرقية</b></td>
                <td style="width:33%; text-align:center;"><img src="logo.png" height="70" onerror="this.style.display='none'"></td>
                <td style="width:33%; text-align:left; font-size:0.75rem;">كشف درجات الطالب<br>العام الدراسي 2025/2026</td>
            </tr>
        </table>

        <div id="studentData" class="student-info-grid"></div>

        <table class="main-table">
            <thead>
                <tr>
                    <th style="text-align: right;">المادة الدراسية</th>
                    <th>الدرجة</th>
                    <th>التقدير</th>
                </tr>
            </thead>
            <tbody id="tableContent"></tbody>
        </table>

        <div class="tops-card no-print">
            <h4 style="margin:0 0 10px 0; color: #856404;"><i class="fa-solid fa-trophy"></i> أوائل الصف الدراسي</h4>
            <div id="podiumContent" style="display: flex; justify-content: space-around; font-size: 0.8rem;"></div>
        </div>

        <div class="ai-box">
            <i class="fa-solid fa-robot" style="color: #2f54eb; font-size: 1.5rem;"></i>
            <div>
                <b style="color: #1d39c4;">تحليل المساعد الذكي (AI Analysis):</b>
                <div id="aiMessage" style="font-size: 0.85rem; margin-top: 5px; line-height: 1.4;"></div>
            </div>
        </div>

        <div style="margin-top: 40px; text-align: left; font-size: 0.8rem; border-top: 1px solid #eee; padding-top: 10px;">
            <p>يعتمد مدير المدرسة: ...........................</p>
        </div>
    </div>

    <div class="no-print" style="text-align: center; margin-top: 20px;">
        <button class="btn-submit" style="width: auto; padding: 12px 40px;" onclick="window.print()">طباعة الشهادة (A4)</button>
        <button class="btn-submit" style="width: auto; padding: 12px 40px; background: #666; margin-right: 10px;" onclick="location.reload()">بحث جديد</button>
    </div>
</div>

<script>
    async function startProcess() {
        const id = document.getElementById('civilId').value.trim();
        if(!id) return alert("يرجى إدخال الرقم");

        const files = ["grade5.json", "grade6.json", "grade7.json", "grade8.json", "grade9.json"];
        let student = null;
        let allClass = [];

        for (let f of files) {
            try {
                const res = await fetch(f + "?v=" + Date.now());
                const data = await res.json();
                student = data.find(s => s["رقم_مدني"].toString() === id);
                if(student) {
                    allClass = data.filter(m => m["الصف"] === student["الصف"]);
                    break;
                }
            } catch(e) {}
        }

        if(student) {
            renderUI(student, allClass);
        } else {
            alert("لم يتم العثور على الرقم المدني.");
        }
    }

    function renderUI(s, classList) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('resultPage').style.display = 'block';

        // 1. تعبئة البيانات
        document.getElementById('studentData').innerHTML = `
            <div>الاسم: <b>${s["الاسم"]}</b></div>
            <div>الرقم المدني: <b>${s["رقم_مدني"]}</b></div>
            <div>الصف: <b>${s["الصف"]}</b></div>
            <div>الشعبة: <b>${s["الشعبة"]}</b></div>
        `;

        // 2. تعبئة الجدول
        const keys = Object.keys(s).filter(k => !["رقم_مدني", "الاسم", "الصف", "الشعبة"].includes(k));
        let html = '';
        let scores = [];
        keys.forEach(k => {
            const v = parseFloat(s[k]);
            scores.push({name: k, val: v});
            html += `<tr><td style="text-align:right;">${k}</td><td>${v}</td><td>${v>=90?'ممتاز':'جيد'}</td></tr>`;
        });
        document.getElementById('tableContent').innerHTML = html;

        // 3. تحليل AI (داخلي سريع لضمان العمل)
        scores.sort((a,b) => b.val - a.val);
        document.getElementById('aiMessage').innerHTML = `بناءً على نتائجك يا <b>${s["الاسم"].split(' ')[0]}</b>، أنت متميز جداً في <b>${scores[0].name}</b>. نوصيك بالاستمرار في هذا الحماس، ومراجعة مادة <b>${scores[scores.length-1].name}</b> لرفع مستواك للأفضل.`;

        // 4. الأوائل
        const tops = classList.map(m => ({
            n: m["الاسم"].split(' ')[0],
            t: keys.reduce((sum, k) => sum + parseFloat(m[k]||0), 0)
        })).sort((a,b) => b.t - a.t).slice(0, 3);

        document.getElementById('podiumContent').innerHTML = tops.map((t, i) => 
            `<div><b>المركز ${i+1}:</b> ${t.n} (${t.t})</div>`
        ).join('');
    }
</script>

</body>
</html>
