<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© Ù„Ù„ØªÙ…ÙŠØ²</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --deep-green: #061f1c;
            --gold-primary: #c5a059;
            --gold-soft: #e3c08d;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.15);
            --text: #e0e6e6;
        }

        body {
            font-family: 'Almarai', sans-serif;
            margin: 0;
            background: var(--deep-green);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(10, 61, 52, 0.8) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 0l50 50-50 50-50-50z' fill='%23ffffff' fill-opacity='0.015'/%3E%3C/svg%3E");
            background-attachment: fixed;
            color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        header {
            padding: 20px 5%;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        .school-info { display: flex; align-items: center; gap: 15px; }
        .school-info img { height: 55px; filter: drop-shadow(0 0 8px var(--gold-primary)); }
        .school-info h1 { font-size: 1.1rem; margin: 0; color: var(--gold-soft); }

        .container { max-width: 900px; margin: 40px auto; padding: 20px; flex: 1; }

        .gateway-box {
            background: var(--glass);
            padding: 60px 30px; border-radius: 40px; text-align: center;
            border: 1px solid var(--border); backdrop-filter: blur(15px);
            box-shadow: 0 40px 100px rgba(0,0,0,0.5);
        }
        .main-input {
            width: 80%; max-width: 400px; padding: 20px; border-radius: 15px;
            border: 1px solid var(--border); background: rgba(0,0,0,0.2);
            color: white; font-size: 1.3rem; text-align: center; margin: 25px 0; outline: none;
            transition: 0.3s;
        }

        .student-id-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 30px; padding: 35px; border: 1px solid var(--border);
            position: relative; overflow: hidden; margin-bottom: 30px;
            display: flex; align-items: center; gap: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .avatar-box {
            width: 100px; height: 100px; border-radius: 20px;
            background: var(--gold-primary); display: flex; align-items: center;
            justify-content: center; font-size: 3rem; color: var(--deep-green);
        }

        .results-wrapper {
            background: var(--glass); border-radius: 25px; overflow: hidden;
            border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(255,255,255,0.05); padding: 18px; text-align: right; color: var(--gold-soft); }
        td { padding: 18px; border-bottom: 1px solid var(--border); font-size: 1.1rem; }
        .grade-val { font-weight: 800; color: var(--gold-primary); font-size: 1.2rem; }

        .btn-gold {
            background: linear-gradient(135deg, #c5a059, #8e6d2e); color: #061f1c;
            padding: 16px 45px; border-radius: 12px; border: none; font-weight: 800;
            cursor: pointer; transition: 0.3s; font-size: 1.1rem;
        }

        /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø© --- */
        .ai-fab { position: fixed; bottom: 30px; left: 30px; width: 65px; height: 65px; background: var(--gold-primary); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.8rem; color: var(--deep-green); cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        
        .ai-chat-window { position: fixed; bottom: 110px; left: 30px; width: 350px; height: 500px; background: #0b2e2a; border: 1px solid var(--gold-primary); border-radius: 25px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .ai-chat-header { background: var(--gold-primary); color: var(--deep-green); padding: 15px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .ai-chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; }
        .bot-msg { background: rgba(255,255,255,0.1); color: var(--text); border-right: 4px solid var(--gold-primary); align-self: flex-start; }
        .user-msg { background: var(--gold-primary); color: var(--deep-green); align-self: flex-end; font-weight: 700; }

        .chat-input-area { padding: 15px; background: rgba(0,0,0,0.3); display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .chat-input-area input { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 10px; color: white; padding: 10px; outline: none; }
        .chat-input-area button { background: var(--gold-primary); border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; color: var(--deep-green); }

        .view { display: none; }
        .view.active { display: block; }

        .modal-tops { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--deep-green); border: 2px solid var(--gold-primary); padding: 30px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; }
    </style>
</head>
<body>

<header class="no-print">
    <div class="school-info">
        <img src="logo.png" alt="Oman Logo">
        <h1>Ø¨ÙˆØ§Ø¨Ø© Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© Ù„Ù„Ù†ØªØ§Ø¦Ø¬</h1>
    </div>
    <button id="btnTops" class="btn-gold" style="padding: 8px 20px; font-size: 0.9rem; display: none;" onclick="showTops()">Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ğŸ†</button>
</header>

<div class="container">
    <section id="searchView" class="view active">
        <div class="gateway-box">
            <i class="fa-solid fa-id-card" style="font-size: 4rem; color: var(--gold-primary); margin-bottom: 20px;"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠ</h2>
            <input type="text" id="civilInput" class="main-input" placeholder="00000000">
            <br>
            <button class="btn-gold" onclick="processSearch()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</button>
        </div>
    </section>

    <section id="resultView" class="view">
        <div class="student-id-card">
            <div class="rank-badge" id="studentRank"></div>
            <div class="avatar-box"><i class="fa-solid fa-user-graduate"></i></div>
            <div class="id-content">
                <h2 id="studentName"></h2>
                <p id="studentClass"></p>
                <p id="studentID"></p>
            </div>
            <div style="margin-right: auto; text-align: center;">
                <div style="font-size: 0.8rem; opacity: 0.6;">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</div>
                <div id="studentAvg" style="font-size: 2.2rem; font-weight: 900; color: var(--gold-primary);"></div>
            </div>
        </div>

        <div class="results-wrapper">
            <table>
                <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th><th style="text-align:center;">Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th style="text-align:center;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th></tr></thead>
                <tbody id="resTableBody"></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:30px;" class="no-print">
            <button class="btn-gold" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
            <button style="background:transparent; color:white; border:none; text-decoration:underline; cursor:pointer;" onclick="location.reload()">Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </section>
</div>

<div class="ai-fab no-print" id="aiFab" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
<div class="ai-chat-window no-print" id="aiChat">
    <div class="ai-chat-header"><span>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ</span> <span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
    <div class="ai-chat-body" id="chatBody"></div>
    <div class="chat-input-area">
        <input type="text" id="userInput" placeholder="Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø¹Ù† Ù…Ø³ØªÙˆØ§Ùƒ..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div class="modal-tops no-print" id="topsModal">
    <div class="modal-content">
        <h2 style="color:var(--gold-primary)">Ø£ÙˆØ§Ø¦Ù„ Ø§Ù„Ø´Ø¹Ø¨Ø©</h2>
        <div id="topsGrid" style="display:flex; justify-content:space-around; margin:20px 0;"></div>
        <button class="btn-gold" onclick="document.getElementById('topsModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    let currentStudent = null;
    let globalMates = [];

    async function processSearch() {
        const civil = document.getElementById('civilInput').value.trim();
        const files = ["grade5.json", "grade6.json", "grade7.json", "grade8.json", "grade9.json"];
        let found = false;

        for(let f of files) {
            try {
                const res = await fetch(f + "?v=" + Math.random());
                const data = await res.json();
                currentStudent = data.find(s => s["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"].toString() === civil);
                if(currentStudent) {
                    globalMates = data.filter(m => m["Ø§Ù„ØµÙ"] === currentStudent["Ø§Ù„ØµÙ"] && m["Ø§Ù„Ø´Ø¹Ø¨Ø©"] === currentStudent["Ø§Ù„Ø´Ø¹Ø¨Ø©"]);
                    found = true; break;
                }
            } catch(e) {}
        }

        if(found) {
            displayUI();
            document.getElementById('aiFab').style.display = 'flex';
            document.getElementById('btnTops').style.display = 'block';
            runInitialAnalysis(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        } else { alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„."); }
    }

    function displayUI() {
        const subjects = Object.keys(currentStudent).filter(k => !["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ØµÙ", "Ø§Ù„Ø´Ø¹Ø¨Ø©"].includes(k));
        const calcSum = (s) => subjects.reduce((a, b) => a + parseFloat(s[b] || 0), 0);
        
        const sorted = globalMates.map(m => ({id: m["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"], t: calcSum(m)})).sort((a,b) => b.t - a.t);
        const rank = sorted.findIndex(x => x.id === currentStudent["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"]) + 1;
        const avg = (calcSum(currentStudent) / subjects.length).toFixed(1);

        document.getElementById('studentName').innerText = currentStudent["Ø§Ù„Ø§Ø³Ù…"];
        document.getElementById('studentClass').innerText = `Ø§Ù„ØµÙ: ${currentStudent["Ø§Ù„ØµÙ"]} / Ø§Ù„Ø´Ø¹Ø¨Ø©: ${currentStudent["Ø§Ù„Ø´Ø¹Ø¨Ø©"]}`;
        document.getElementById('studentID').innerText = `ID: ${currentStudent["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"]}`;
        document.getElementById('studentRank').innerText = `Ø§Ù„Ù…Ø±ÙƒØ²: ${rank}`;
        document.getElementById('studentAvg').innerText = avg + "%";

        let rows = '';
        subjects.forEach(sub => {
            const v = parseFloat(currentStudent[sub]);
            rows += `<tr><td>${sub}</td><td style="text-align:center;" class="grade-val">${v}</td><td style="text-align:center;">${v>=90?'Ù…Ù…ØªØ§Ø²':v>=80?'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹':'Ù…Ù‚Ø¨ÙˆÙ„'}</td></tr>`;
        });
        document.getElementById('resTableBody').innerHTML = rows;
        document.getElementById('searchView').classList.remove('active');
        document.getElementById('resultView').classList.add('active');
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
    function runInitialAnalysis() {
        const subjects = Object.keys(currentStudent).filter(k => !["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ØµÙ", "Ø§Ù„Ø´Ø¹Ø¨Ø©"].includes(k));
        const chat = document.getElementById('chatBody');
        
        let strength = [], weak = [];
        subjects.forEach(s => {
            if(parseFloat(currentStudent[s]) >= 90) strength.push(s);
            else if(parseFloat(currentStudent[s]) < 70) weak.push(s);
        });

        let analysisHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentStudent["Ø§Ù„Ø§Ø³Ù…"].split(' ')[0]}! Ø£Ù†Ø§ Ù…Ø­Ù„Ù„Ùƒ Ø§Ù„Ø°ÙƒÙŠØŒ Ø¥Ù„ÙŠÙƒ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:<br><br>`;
        analysisHTML += `âœ… <b>Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©:</b> Ø£Ù†Øª Ù…Ø¨Ø¯Ø¹ ÙÙŠ ${strength.length > 0 ? strength.join(' Ùˆ ') : 'ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø³ØªÙˆØ§Ù‡Ø§ Ù…ØªÙˆØ§Ø²Ù†'}.<br>`;
        if(weak.length > 0) {
            analysisHTML += `âš ï¸ <b>Ù†ØµÙŠØ­Ø©:</b> Ù…Ø§Ø¯Ø© (${weak.join(' Ùˆ ')}) ØªØ­ØªØ§Ø¬ Ù…Ù†Ùƒ ØªØ±ÙƒÙŠØ²Ø§Ù‹ Ø£ÙƒØ«Ø± ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù„Ø±ÙØ¹ Ù…Ø¹Ø¯Ù„Ùƒ.`;
        } else {
            analysisHTML += `â­ <b>Ù†ØµÙŠØ­Ø©:</b> Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¦Ø¹ØŒ ÙØ£Ù†Øª ØªØ³ÙŠØ± ÙÙŠ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø£ÙˆØ§Ø¦Ù„!`;
        }

        addChatMessage(analysisHTML, 'bot');
    }

    function addChatMessage(text, sender) {
        const chat = document.getElementById('chatBody');
        const div = document.createElement('div');
        div.className = `msg ${sender}-msg`;
        div.innerHTML = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('userInput');
        if(!input.value.trim()) return;

        addChatMessage(input.value, 'user');
        const q = input.value;
        input.value = '';

        setTimeout(() => {
            let response = "Ø³Ø¤Ø§Ù„ Ù…Ù…ØªØ§Ø²! Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø£Ù†ØµØ­Ùƒ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ ØªÙ†Ø¸ÙŠÙ… ÙˆÙ‚ØªÙƒ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.";
            if(q.includes("Ø¯Ø±Ø¬ØªÙŠ") || q.includes("Ù…Ø¹Ø¯Ù„ÙŠ")) response = `Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ${document.getElementById('studentAvg').innerText}.`;
            if(q.includes("Ù…Ø±ÙƒØ²") || q.includes("ØªØ±ØªÙŠØ¨")) response = `Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ ${document.getElementById('studentRank').innerText}.`;
            
            addChatMessage(response, 'bot');
        }, 800);
    }

    function toggleChat() {
        const win = document.getElementById('aiChat');
        win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
    }

    function showTops() {
        const subjects = Object.keys(currentStudent).filter(k => !["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ØµÙ", "Ø§Ù„Ø´Ø¹Ø¨Ø©"].includes(k));
        const sorted = globalMates.map(m => ({
            name: m["Ø§Ù„Ø§Ø³Ù…"].split(' ')[0], 
            t: subjects.reduce((a,b)=>a+parseFloat(m[b]||0),0)
        })).sort((a,b)=>b.t-a.t).slice(0,3);

        document.getElementById('topsGrid').innerHTML = sorted.map((s,i)=>`
            <div style="text-align:center; background:var(--glass); padding:10px; border-radius:15px; border:1px solid var(--gold-primary)">
                <div style="font-size:1.5rem">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]}</div>
                <div style="font-size:0.8rem">${s.name}</div>
                <div style="color:var(--gold-primary); font-weight:bold">${s.t.toFixed(1)}</div>
            </div>
        `).join('');
        document.getElementById('topsModal').style.display = 'flex';
    }
</script>
</body>
</html>
