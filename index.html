<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>بوابة صلالة الشرقية | المحلل الذكي</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root { --main: #062a24; --gold: #c5a059; --glass: rgba(255, 255, 255, 0.95); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Almarai', sans-serif; }
        body { background: #f4f7f6; color: #1a202c; }

        .official-header {
            background: var(--main); color: white; padding: 12px 5%; 
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; 
            border-bottom: 4px solid var(--gold);
        }
        .h-logo img { height: 55px; }

        .container { width: 92%; max-width: 850px; margin: 20px auto; }

        /* واجهة البحث */
        #searchCard {
            max-width: 400px; margin: 100px auto; text-align: center;
            background: white; padding: 40px; border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #eee; text-align: center; font-size: 1.2rem; outline: none; margin-bottom: 20px; }
        .btn-entry { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }

        /* منطقة النتائج (مخفية في البداية) */
        #resultArea { display: none; animation: slideUp 0.8s ease; }
        .student-card {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-right: 6px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }
        .table-box { border: 2px solid var(--gold); border-radius: 15px; overflow: hidden; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: right; font-size: 0.8rem; color: var(--main); }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-weight: 700; }

        /* --- الروبوت الصغير جداً --- */
        #aiTrigger {
            position: fixed; bottom: 20px; left: 20px; z-index: 9999;
            display: none; flex-direction: column; align-items: center;
        }
        .robot-mini {
            width: 55px; height: 55px; background: var(--main); border: 2px solid var(--gold);
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: float 3s infinite ease-in-out;
        }
        .robot-mini img { width: 80%; height: 80%; object-fit: contain; }
        
        .hint-bubble {
            background: var(--main); color: white; font-size: 0.7rem; padding: 5px 10px;
            border-radius: 10px; margin-bottom: 8px; font-weight: bold;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1); position: relative;
        }

        /* نافذة الدردشة */
        .chat-box {
            position: fixed; bottom: 85px; left: 20px; width: 300px; height: 400px;
            background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px;
            border: 1px solid var(--gold); box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            display: none; flex-direction: column; z-index: 10000;
        }
        .chat-h { background: var(--main); color: white; padding: 12px; font-size: 0.8rem; font-weight: bold; border-radius: 19px 19px 0 0; }
        .chat-b { flex: 1; padding: 15px; overflow-y: auto; font-size: 0.85rem; }
        .chat-f { padding: 10px; display: flex; gap: 5px; background: white; border-radius: 0 0 19px 19px; }
        .chat-f input { margin: 0; padding: 8px; font-size: 0.8rem; border-radius: 10px; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print, #aiTrigger, .chat-box { display: none !important; } }
    </style>
</head>
<body>

<header class="official-header">
    <div class="h-info" style="text-align: right; font-size: 0.7rem;"><b>سلطنة عُمان</b>وزارة التربية والتعليم</div>
    <div class="h-logo"><img src="logo.png" alt="Logo"></div>
    <div class="h-info" style="text-align: left; font-size: 0.7rem;"><b>مدرسة صلالة الشرقية</b>المحلل الذكي</div>
</header>

<div class="container">
    <section id="searchCard" class="no-print">
        <h2 style="margin-bottom:20px; color: var(--main);">نتائج الطلاب</h2>
        <input type="text" id="civilIn" placeholder="أدخل الرقم المدني">
        <button class="btn-entry" onclick="processSearch()">استعلام</button>
    </section>

    <div id="resultArea">
        <div class="student-card">
            <div>
                <h2 id="resName" style="color:var(--main);"></h2>
                <p id="resClass" style="color: #666; font-size: 0.9rem;"></p>
            </div>
            <div style="text-align:center">
                <div id="resAvg" style="font-size: 1.5rem; font-weight: 900; color: var(--gold);"></div>
                <div style="font-size:0.6rem; font-weight:bold;">المعدل العام</div>
            </div>
        </div>
        <div class="table-box">
            <table>
                <thead><tr><th>المادة الدراسية</th><th style="text-align:center">الدرجة</th><th>الحالة</th></tr></thead>
                <tbody id="resTable"></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="window.print()" class="no-print" style="background:none; border:none; color:var(--main); font-weight:bold; cursor:pointer;">طباعة الشهادة</button>
        </div>
    </div>
</div>

<div id="aiTrigger" class="no-print">
    <div class="hint-bubble" id="botHint">اضغط عليّ لإظهار نتيجتك</div>
    <div class="robot-mini" onclick="activateRobot()">
        <img src="https://pollinations.ai/p/cute%20small%20robot%20head,%20friendly%20eyes,%20hi-tech%20minimalist?width=100&height=100&nologo=true" alt="Bot">
    </div>
</div>

<div class="chat-box no-print" id="chatWin">
    <div class="chat-h">المحلل الذكي - صلالة الشرقية</div>
    <div class="chat-b" id="chatLogs"></div>
    <div class="chat-f">
        <input type="text" id="userIn" placeholder="اسأل المحلل..." onkeypress="if(event.key==='Enter') userTalk()">
    </div>
</div>

<script>
    let currentStudent = null;

    async function processSearch() {
        const id = document.getElementById('civilIn').value.trim();
        if(!id) return;
        
        const files = ["grade5.json", "grade6.json", "grade7.json", "grade8.json", "grade9.json"];
        for(let f of files) {
            try {
                const r = await fetch(f);
                const data = await r.json();
                currentStudent = data.find(s => s["رقم_مدني"].toString() === id);
                if(currentStudent) {
                    // إخفاء البحث وإظهار الروبوت فقط
                    document.getElementById('searchCard').style.display = 'none';
                    document.getElementById('aiTrigger').style.display = 'flex';
                    return;
                }
            } catch(e) {}
        }
        alert("الرقم المدني غير موجود.");
    }

    function activateRobot() {
        // إظهار النتائج الآن عند الضغط على الروبوت
        const subs = Object.keys(currentStudent).filter(k => !["رقم_مدني", "الاسم", "الاسم", "الصف", "الشعبة"].includes(k));
        const scores = subs.map(s => parseFloat(currentStudent[s]));
        const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);

        document.getElementById('resName').innerText = currentStudent["الاسم"];
        document.getElementById('resClass').innerText = `الصف ${currentStudent["الصف"]} / الشعبة ${currentStudent["الشعبة"]}`;
        document.getElementById('resAvg').innerText = avg + "%";
        
        document.getElementById('resTable').innerHTML = subs.map(s => `
            <tr>
                <td>${s}</td>
                <td align="center" style="color:var(--main)">${currentStudent[s]}</td>
                <td style="font-size:0.7rem; color:#888;">${currentStudent[s]>=90?'ممتاز':'جيد'}</td>
            </tr>`).join('');

        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('chatWin').style.display = 'flex';
        document.getElementById('botHint').innerText = "أنا هنا لمساعدتك";
        
        addLog(`مرحباً ${currentStudent["الاسم"].split(' ')[0]}! لقد قمت بسحب نتيجتك بنجاح. معدلك هو ${avg}%. هل تريدني أن أحلل لك مادة معينة؟`, 'ai');
    }

    function addLog(txt, type) {
        const logs = document.getElementById('chatLogs');
        const d = document.createElement('div');
        d.style.marginBottom = "10px";
        d.style.padding = "10px";
        d.style.borderRadius = "10px";
        d.style.background = type === 'ai' ? "#f0f4f8" : "var(--gold)";
        d.style.color = type === 'ai' ? "#333" : "white";
        d.innerText = txt;
        logs.appendChild(d);
        logs.scrollTop = logs.scrollHeight;
    }

    function userTalk() {
        const i = document.getElementById('userIn');
        if(!i.value) return;
        addLog(i.value, 'user');
        const q = i.value;
        i.value = '';
        setTimeout(() => addLog("تحليل ذكي: درجاتك في المواد العلمية ممتازة جداً، استمر على هذا النهج!", 'ai'), 1000);
    }
</script>
</body>
</html>
