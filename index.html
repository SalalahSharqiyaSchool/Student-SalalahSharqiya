<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© Ù„Ù„ØªÙ…ÙŠØ²</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --deep-green: #061f1c;
            --gold-primary: #c5a059;
            --gold-soft: #e3c08d;
            --glass: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.15);
            --text: #e0e6e6;
        }

        body {
            font-family: 'Almarai', sans-serif;
            margin: 0;
            background: var(--deep-green);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(10, 61, 52, 0.8) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 0l50 50-50 50-50-50z' fill='%23ffffff' fill-opacity='0.015'/%3E%3C/svg%3E");
            background-attachment: fixed;
            color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- Header --- */
        header {
            padding: 20px 5%;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        .school-info { display: flex; align-items: center; gap: 15px; }
        .school-info img { height: 55px; filter: drop-shadow(0 0 8px var(--gold-primary)); }
        .school-info h1 { font-size: 1.1rem; margin: 0; color: var(--gold-soft); }

        .container { max-width: 900px; margin: 40px auto; padding: 20px; flex: 1; }

        /* --- Search Card --- */
        .gateway-box {
            background: var(--glass);
            padding: 60px 30px; border-radius: 40px; text-align: center;
            border: 1px solid var(--border); backdrop-filter: blur(15px);
            box-shadow: 0 40px 100px rgba(0,0,0,0.5);
        }
        .main-input {
            width: 80%; max-width: 400px; padding: 20px; border-radius: 15px;
            border: 1px solid var(--border); background: rgba(0,0,0,0.2);
            color: white; font-size: 1.3rem; text-align: center; margin: 25px 0; outline: none;
            transition: 0.3s;
        }
        .main-input:focus { border-color: var(--gold-primary); box-shadow: 0 0 20px rgba(197,160,89,0.2); }

        /* --- Student Identity Card (Visual Focus) --- */
        .student-id-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 30px; padding: 35px; border: 1px solid var(--border);
            position: relative; overflow: hidden; margin-bottom: 30px;
            display: flex; align-items: center; gap: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .student-id-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(197,160,89,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        .avatar-box {
            width: 100px; height: 100px; border-radius: 20px;
            background: var(--gold-primary); display: flex; align-items: center;
            justify-content: center; font-size: 3rem; color: var(--deep-green);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .id-content h2 { margin: 0; font-size: 1.8rem; color: var(--gold-soft); }
        .id-content p { margin: 5px 0; opacity: 0.8; font-size: 1rem; }
        .rank-badge {
            position: absolute; top: 20px; left: 20px;
            background: var(--gold-primary); color: var(--deep-green);
            padding: 8px 15px; border-radius: 12px; font-weight: 800;
        }

        /* --- Results Table --- */
        .results-wrapper {
            background: var(--glass); border-radius: 25px; overflow: hidden;
            border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(255,255,255,0.05); padding: 18px; text-align: right; color: var(--gold-soft); }
        td { padding: 18px; border-bottom: 1px solid var(--border); font-size: 1.1rem; }
        .grade-val { font-weight: 800; color: var(--gold-primary); font-size: 1.2rem; }

        /* --- Buttons --- */
        .btn-gold {
            background: linear-gradient(135deg, #c5a059, #8e6d2e); color: #061f1c;
            padding: 16px 45px; border-radius: 12px; border: none; font-weight: 800;
            cursor: pointer; transition: 0.3s; font-size: 1.1rem;
        }
        .btn-gold:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(197,160,89,0.3); }

        .view { display: none; }
        .view.active { display: block; animation: zoomIn 0.5s ease-out; }
        @keyframes zoomIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

        /* --- Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©: ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙˆØ²Ø± Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ --- */
        .ai-fab { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; background: var(--gold-primary); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--deep-green); cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; }
        .ai-chat-window { position: fixed; bottom: 100px; left: 30px; width: 320px; background: var(--deep-green); border: 1px solid var(--gold-primary); border-radius: 20px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .ai-chat-header { background: var(--gold-primary); color: var(--deep-green); padding: 15px; font-weight: 800; display: flex; justify-content: space-between; }
        .ai-chat-body { height: 300px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 0.9rem; }
        .msg { padding: 10px; border-radius: 10px; max-width: 80%; }
        .bot-msg { background: var(--glass); border-right: 3px solid var(--gold-primary); }
        
        .modal-tops { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--deep-green); border: 2px solid var(--gold-primary); padding: 30px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; }
        .tops-grid { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        .top-card { background: var(--glass); border: 1px solid var(--border); padding: 15px; border-radius: 15px; flex: 1; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .student-id-card { border: 2px solid #c5a059 !important; background: white !important; color: black !important; }
            .id-content h2, .rank-badge { color: #8e6d2e !important; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <div class="school-info">
        <img src="logo.png" alt="Oman Logo">
        <h1>Ø¨ÙˆØ§Ø¨Ø© Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© Ù„Ù„Ù†ØªØ§Ø¦Ø¬</h1>
    </div>
    <button id="btnTops" class="btn-gold" style="padding: 8px 20px; font-size: 0.9rem; display: none;" onclick="showTops()">Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ğŸ†</button>
    <div style="color: var(--gold-soft); font-size: 1.2rem;"><i class="fa-solid fa-shield-halved"></i> 2026</div>
</header>

<div class="container">
    
    <section id="searchView" class="view active">
        <div class="gateway-box">
            <i class="fa-solid fa-id-card" style="font-size: 4rem; color: var(--gold-primary); margin-bottom: 20px;"></i>
            <h2 style="font-size: 2rem;">Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠ</h2>
            <p style="opacity: 0.7;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 8 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            
            <input type="text" id="civilInput" class="main-input" placeholder="00000000">
            <br>
            <button class="btn-gold" onclick="processSearch()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</button>
        </div>
    </section>

    <section id="resultView" class="view">
        
        <div class="student-id-card" id="studentIdCard">
            <div class="rank-badge" id="studentRank">Ø§Ù„Ù…Ø±ÙƒØ²: -</div>
            <div class="avatar-box"><i class="fa-solid fa-user-graduate"></i></div>
            <div class="id-content">
                <h2 id="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</h2>
                <p id="studentClass">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ / Ø§Ù„Ø´Ø¹Ø¨Ø©</p>
                <p id="studentID" style="font-family: monospace; letter-spacing: 2px;">ID: 00000000</p>
            </div>
            <div style="margin-right: auto; text-align: center;">
                <div style="font-size: 0.8rem; opacity: 0.6;">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</div>
                <div id="studentAvg" style="font-size: 2.2rem; font-weight: 900; color: var(--gold-primary);">0%</div>
            </div>
        </div>

        <div class="results-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>
                        <th style="text-align: center;">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</th>
                        <th style="text-align: center;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                    </tr>
                </thead>
                <tbody id="resTableBody"></tbody>
            </table>
        </div>

        <div style="text-align: center; margin-top: 40px;" class="no-print">
            <button class="btn-gold" onclick="window.print()"><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
            <button style="background:transparent; color:white; border:none; cursor:pointer; margin-right:20px; text-decoration:underline;" onclick="location.reload()">Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </section>
</div>

<div class="ai-fab no-print" id="aiFab" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
<div class="ai-chat-window no-print" id="aiChat">
    <div class="ai-chat-header"><span>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ</span> <span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
    <div class="ai-chat-body" id="chatBody"></div>
</div>

<div class="modal-tops no-print" id="topsModal">
    <div class="modal-content">
        <h2 style="color: var(--gold-primary);">Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©</h2>
        <div class="tops-grid" id="topsGrid"></div>
        <button class="btn-gold" style="margin-top: 25px;" onclick="document.getElementById('topsModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    let globalMates = []; // Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ø­ÙØ¸ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡

    async function processSearch() {
        const civil = document.getElementById('civilInput').value.trim();
        if(!civil) return;

        const files = ["grade5.json", "grade6.json", "grade7.json", "grade8.json", "grade9.json"];
        let student = null, mates = [];

        for(let f of files) {
            try {
                const res = await fetch(f + "?cache=" + Math.random());
                const data = await res.json();
                student = data.find(s => s["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"].toString() === civil);
                if(student) {
                    mates = data.filter(m => m["Ø§Ù„ØµÙ"] === student["Ø§Ù„ØµÙ"] && m["Ø§Ù„Ø´Ø¹Ø¨Ø©"] === student["Ø§Ù„Ø´Ø¹Ø¨Ø©"]);
                    globalMates = mates; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£ÙˆØ§Ø¦Ù„
                    break;
                }
            } catch(e) { console.error("Error loading file"); }
        }

        if(student) {
            displayUI(student, mates);
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙˆØ²Ø± Ø§Ù„Ø£ÙˆØ§Ø¦Ù„
            document.getElementById('aiFab').style.display = 'flex';
            document.getElementById('btnTops').style.display = 'block';
        } else {
            alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
        }
    }

    function displayUI(student, mates) {
        const subjects = Object.keys(student).filter(k => !["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ØµÙ", "Ø§Ù„Ø´Ø¹Ø¨Ø©"].includes(k));
        const calcTotal = (s) => subjects.reduce((a, b) => a + parseFloat(s[b] || 0), 0);
        
        const sorted = mates.map(m => ({
            id: m["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"], total: calcTotal(m)
        })).sort((a,b) => b.total - a.total);

        const rank = sorted.findIndex(x => x.id.toString() === student["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"].toString()) + 1;
        const totalScore = calcTotal(student);
        const avg = (totalScore / subjects.length).toFixed(1);

        document.getElementById('studentName').innerText = student["Ø§Ù„Ø§Ø³Ù…"];
        document.getElementById('studentClass').innerText = `Ø§Ù„ØµÙ: ${student["Ø§Ù„ØµÙ"]} / Ø§Ù„Ø´Ø¹Ø¨Ø©: ${student["Ø§Ù„Ø´Ø¹Ø¨Ø©"]}`;
        document.getElementById('studentID').innerText = `ID: ${student["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ"]}`;
        document.getElementById('studentRank').innerText = `Ø§Ù„Ù…Ø±ÙƒØ²: ${rank}`;
        document.getElementById('studentAvg').innerText = avg + "%";

        let rows = '';
        subjects.forEach(sub => {
            const v = parseFloat(student[sub]);
            rows += `
                <tr>
                    <td style="font-weight:700;">${sub}</td>
                    <td style="text-align:center;" class="grade-val">${v}</td>
                    <td style="text-align:center;">${v >= 90 ? 'Ù…Ù…ØªØ§Ø²' : v >= 80 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' : v >= 50 ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ø¶Ø¹ÙŠÙ'}</td>
                </tr>`;
        });
        document.getElementById('resTableBody').innerHTML = rows;

        document.getElementById('searchView').classList.remove('active');
        document.getElementById('resultView').classList.add('active');

        // ØªØ¬Ù‡ÙŠØ² Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ø£ÙˆÙ„Ù‰
        const firstName = student["Ø§Ù„Ø§Ø³Ù…"].split(' ')[0];
        document.getElementById('chatBody').innerHTML = `<div class="msg bot-msg">Ø£Ù‡Ù„Ø§Ù‹ ${firstName}! Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ÙƒØŒ Ù…Ø¹Ø¯Ù„Ùƒ Ù‡Ùˆ ${avg}% ÙˆØ£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${rank}. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ…ÙŠØ²!</div>`;
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    function toggleChat() {
        const chat = document.getElementById('aiChat');
        chat.style.display = (chat.style.display === 'flex') ? 'none' : 'flex';
    }

    function showTops() {
        if(globalMates.length === 0) return;
        const subjects = Object.keys(globalMates[0]).filter(k => !["Ø±Ù‚Ù…_Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ØµÙ", "Ø§Ù„Ø´Ø¹Ø¨Ø©"].includes(k));
        const calcTotal = (s) => subjects.reduce((a, b) => a + parseFloat(s[b] || 0), 0);
        
        const sorted = globalMates.map(m => ({
            name: m["Ø§Ù„Ø§Ø³Ù…"].split(' ')[0], total: calcTotal(m)
        })).sort((a,b) => b.total - a.total).slice(0, 3);

        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        let html = '';
        sorted.forEach((s, i) => {
            html += `<div class="top-card"><div>${medals[i]}</div><div style="font-size:0.8rem; margin:5px 0;">${s.name}</div><div style="color:var(--gold-primary); font-weight:bold;">${s.total.toFixed(1)}</div></div>`;
        });
        document.getElementById('topsGrid').innerHTML = html;
        document.getElementById('topsModal').style.display = 'flex';
    }
</script>

</body>
</html>
