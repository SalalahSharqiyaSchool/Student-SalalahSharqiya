<script>
    let currentData = null;
    let allStudents = [];

    // دالة تطبيع احترافية: تزيل المسافات، التشكيل، وتوحد الحروف
    function normalizeArabic(text) {
        if (!text) return "";
        return text.toString()
            .replace(/[أإآ]/g, 'ا')
            .replace(/ة/g, 'ه')
            .replace(/ى/g, 'ي')
            .replace(/[\u064B-\u0652]/g, "") // إزالة التشكيل
            .replace(/\s+/g, '') // إزالة كافة المسافات تماماً للمقارنة
            .trim();
    }

    window.onload = async () => {
        try {
            // تحميل الملف مع منع التخزين المؤقت (Cache) لضمان رؤية التحديثات
            const res = await fetch("students_final_results.json?v=" + Date.now());
            if (!res.ok) throw new Error("الملف غير موجود");
            allStudents = await res.json();
            
            // تحضير الأسماء للبحث مسبقاً لزيادة السرعة
            allStudents.forEach(s => {
                s.normalizedName = normalizeArabic(s.name);
            });
            console.log("تم تحميل " + allStudents.length + " طالب بنجاح");
        } catch(e) {
            console.error("فشل تحميل البيانات:", e);
            alert("خطأ: لم يتم العثور على ملف students_final_results.json بجانب صفحة الويب.");
        }
    };

    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');

    // إظهار الاقتراحات أثناء الكتابة
    nameInput.oninput = () => {
        const val = normalizeArabic(nameInput.value);
        if(val.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }
        // البحث عن أي طالب يحتوي اسمه على الحروف المكتوبة
        const matches = allStudents.filter(s => s.normalizedName.includes(val)).slice(0, 10);
        if(matches.length > 0) {
            suggestionsBox.innerHTML = matches.map(m => 
                `<div class="suggestion-item" onclick="selectName('${m.name.replace(/'/g, "\\'")}')">${m.name}</div>`
            ).join('');
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    };

    function selectName(name) {
        nameInput.value = name;
        suggestionsBox.style.display = 'none';
        searchStudent();
    }

    async function searchStudent() {
        const inputVal = normalizeArabic(nameInput.value);
        if(!inputVal) return;
        
        // البحث عن تطابق
        const found = allStudents.find(s => s.normalizedName === inputVal || s.normalizedName.includes(inputVal));
        
        if(found) {
            currentData = found;
            document.getElementById('resName').innerText = found.name;
            document.getElementById('resStatus').innerText = found.status || "مستجد";
            
            let rows = '', totalScore = 0, count = 0;
            
            // مرونة في قراءة البيانات (سواء كانت results أو grades)
            const dataObjects = found.results || found.grades;
            if(!dataObjects) {
                alert("بيانات الدرجات غير موجودة لهذا الطالب في الملف.");
                return;
            }

            const subjects = Object.keys(dataObjects);
            
            subjects.forEach(sub => {
                const score = dataObjects[sub].score;
                const level = dataObjects[sub].level;
                
                // تنظيف الدرجة إذا كانت نصاً يحتوي على أرقام
                const numericScore = parseFloat(score);
                if(!isNaN(numericScore)) {
                    totalScore += numericScore;
                    count++;
                }
                
                rows += `<tr>
                            <td style="text-align:right; font-weight:bold;">${sub}</td>
                            <td>${score || '-'}</td>
                            <td style="color:var(--royal-green); font-weight:bold;">${level || '-'}</td>
                         </tr>`;
            });
            
            // حساب المعدل والمستوى العام
            const avg = count > 0 ? (totalScore / count) : 0;
            let generalLevel = 'د';
            if(avg >= 90) generalLevel = 'أ';
            else if(avg >= 80) generalLevel = 'ب';
            else if(avg >= 65) generalLevel = 'ج';
            else if(avg >= 50) generalLevel = 'د';
            else generalLevel = 'هـ';

            document.getElementById('resLevel').innerText = `المستوى العام: ${generalLevel} (${avg.toFixed(1)}%)`;
            document.getElementById('gradesBody').innerHTML = rows;
            
            // التبديل بين الواجهات
            document.getElementById('searchView').style.display = 'none';
            document.getElementById('resultView').style.display = 'block';
            document.getElementById('ai-btn').style.display = 'flex';
            suggestionsBox.style.display = 'none';
        } else { 
            alert("الاسم غير موجود. جرب كتابة الاسم الأول فقط أو تأكد من مطابقة اسم الطالب لما هو موجود في كشف الإكسل."); 
        }
    }

    // دالات المستشار الذكي AI تبقى كما هي
    function toggleAI() {
        const box = document.getElementById('ai-box');
        box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
        if(box.style.display === 'flex' && !document.getElementById('aiChat').innerHTML) runAI();
    }

    async function runAI() {
        const chat = document.getElementById('aiChat');
        chat.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري تحليل النتيجة...';
        const marks = JSON.stringify(currentData.results || currentData.grades);
        const p = `أنت معلم عماني مخلص، حلل درجات الطالب ${currentData.name}: ${marks}. أعط نصيحة تربوية بناءً على هذه المستويات.`;
        try {
            const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(p)}`);
            const text = await res.text();
            chat.innerHTML = text.replace(/\n/g, '<br>');
        } catch(e) { chat.innerHTML = "المستشار الذكي مشغول حالياً، جرب لاحقاً."; }
    }

    async function sendMsg() {
        const inp = document.getElementById('aiInp');
        const chat = document.getElementById('aiChat');
        if(!inp.value) return;
        chat.innerHTML += `<div style="color:var(--royal-green); margin-top:10px;"><b>أنت:</b> ${inp.value}</div>`;
        const q = inp.value; inp.value = '';
        const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent("أجب كمعلم عماني: " + q)}`);
        const text = await res.text();
        chat.innerHTML += `<div style="margin-top:5px;"><b>المعلم:</b> ${text.replace(/\n/g, '<br>')}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }
</script>
