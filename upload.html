<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>محول نتائج مدرسة صلالة الشرقية - منفرد</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f4f7f6; padding: 30px; text-align: center; }
        .container { background: white; padding: 30px; border-radius: 15px; max-width: 600px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid #0057b8; }
        .file-box { border: 2px dashed #0057b8; padding: 25px; margin: 20px 0; border-radius: 10px; cursor: pointer; background: #fafafa; }
        .file-box:hover { background: #f0f7ff; }
        button { background: #0057b8; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; width: 100%; font-weight: bold; }
        #status { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .note { font-size: 0.85rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>محول الدرجات (ملف واحد لكل صف)</h2>
    <p>قم برفع ملف الصف الدراسي لتحويله إلى JSON</p>
    
    <div class="file-box" onclick="document.getElementById('excelFile').click()">
        <span id="fileInfo">اضغط هنا لاختيار ملف الإكسل</span>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="updateInfo()">
    </div>
    
    <button id="convertBtn" onclick="startSingleConversion()">تحويل وحفظ الملف الحالي</button>
    <div id="status"></div>
    <p class="note">سيتم حفظ الملف باسم يحتوي على رقم الصف تلقائياً</p>
</div>

<script>
function updateInfo() {
    const file = document.getElementById('excelFile').files[0];
    if(file) {
        document.getElementById('fileInfo').innerText = `الملف المختار: ${file.name}`;
    }
}

async function startSingleConversion() {
    const fileInput = document.getElementById('excelFile');
    const status = document.getElementById('status');
    
    if (fileInput.files.length === 0) {
        alert("يرجى اختيار ملف أولاً");
        return;
    }

    const file = fileInput.files[0];
    status.innerHTML = "جاري المعالجة...";
    status.style.color = "black";

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, {type: 'array'});
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});

        // 1. البحث عن صف العناوين
        let hIdx = rows.findIndex(r => r.some(c => String(c).includes("اسم الطالب")));
        if (hIdx === -1) {
            status.innerHTML = "❌ خطأ: لم يتم العثور على عمود 'اسم الطالب' داخل الملف.";
            status.style.color = "red";
            return;
        }

        const headers = rows[hIdx];
        const nameCol = headers.findIndex(h => String(h).includes("اسم الطالب"));
        
        // استخراج رقم الصف من اسم الملف
        const gradeMatch = file.name.match(/(\d+)/);
        const gradeNum = gradeMatch ? gradeMatch[1] : "Unknown";
        const gradeTitle = "الصف " + gradeNum;

        // 2. المواد (أضفنا المهارات الحياتية والموسيقية لدعم التاسع)
        const possibleSubjects = [
            "التربية الإسلامية", "اللغة العربية", "اللغة الإنجليزية", 
            "الرياضيات", "العلوم", "الدراسات الاجتماعية", 
            "تقنية المعلومات", "المهارات الحياتية", "التربية البدنية", 
            "الفنون البصرية", "المهارات الموسيقية", "الفنون الموسيقية"
        ];

        let subMap = {};
        possibleSubjects.forEach(sub => {
            let col = headers.findIndex(h => String(h).includes(sub));
            if (col !== -1) subMap[sub] = col;
        });

        // 3. قراءة البيانات
        let resultsArray = [];
        for (let i = hIdx + 1; i < rows.length; i++) {
            const row = rows[i];
            const name = String(row[nameCol] || "").trim();
            const rowStr = row.join(" ");

            // التأكد أن الصف يخص طالب (الاسم طويل ويحتوي على مستجد/منقول أو مقيد)
            if (name.length > 8 && (rowStr.includes("مستجد") || rowStr.includes("منقول") || rowStr.includes("مقيد"))) {
                let results = {};
                for (let [sub, col] of Object.entries(subMap)) {
                    let score = row[col] || "---";
                    let level = "---";
                    
                    // البحث عن المستوى في الخلايا المحيطة بالدرجة
                    [col-1, col+1, col-2, col+2].forEach(nearCol => {
                        let val = String(row[nearCol] || "").trim();
                        if (val.length === 1 && /[أ-ي]/.test(val)) level = val;
                    });

                    results[sub] = { score: score, level: level };
                }
                resultsArray.push({
                    name: name,
                    grade: gradeTitle,
                    status: rowStr.includes("منقول") ? "منقول" : "مستجد",
                    results: results
                });
            }
        }

        // 4. التحميل
        if(resultsArray.length > 0) {
            const blob = new Blob([JSON.stringify(resultsArray, null, 4)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `results_grade_${gradeNum}.json`;
            a.click();
            status.innerHTML = `✅ تم بنجاح!\nاستخراج ${resultsArray.length} طالب من ${gradeTitle}.\nتم تحميل الملف باسم: results_grade_${gradeNum}.json`;
            status.style.color = "green";
        } else {
            status.innerHTML = "⚠️ لم يتم العثور على بيانات طلاب تتطابق مع الشروط.";
            status.style.color = "orange";
        }

    } catch (error) {
        status.innerHTML = "❌ حدث خطأ أثناء المعالجة: " + error.message;
        status.style.color = "red";
    }
}
</script>
</body>
</html>
