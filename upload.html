<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© - Ø°ÙƒÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f4f7f6; padding: 20px; text-align: center; color: #333; }
        .container { background: white; padding: 30px; border-radius: 15px; max-width: 650px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid #0057b8; }
        .file-box { border: 2px dashed #0057b8; padding: 30px; margin: 20px 0; border-radius: 10px; cursor: pointer; background: #fafafa; transition: 0.3s; }
        .file-box:hover { background: #f0f7ff; border-color: #c5a059; }
        button { background: #0057b8; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; width: 100%; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0a3d34; }
        #status { margin-top: 20px; font-weight: bold; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; }
        .instructions { text-align: right; background: #fffde7; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.9rem; border-right: 5px solid #fbc02d; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #0057b8;">Ù…Ø­ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø°ÙƒÙŠ (Ù…Ù„Ù Ù…Ù†ÙØ±Ø¯)</h2>
    <p>Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ ØµÙ Ø¹Ù„Ù‰ Ø­Ø¯Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</p>
    
    <div class="file-box" onclick="document.getElementById('excelFile').click()">
        <span id="fileInfo">ğŸ“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ (Excel)</span>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="updateInfo()">
    </div>
    
    <button id="convertBtn" onclick="startSingleConversion()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆØ­ÙØ¸Ù‡ Ø¨ØµÙŠØºØ© JSON</button>
    
    <div id="status"></div>

    <div class="instructions">
        <b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</b>
        <ul>
            <li>Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨ØµÙ ÙˆØ§Ø­Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³).</li>
            <li>Ø§Ø¶ØºØ· ØªØ­ÙˆÙŠÙ„ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ø³Ù…Ù‡ <code>results_grade_6.json</code>.</li>
            <li>ÙƒØ±Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙÙˆÙ Ø«Ù… Ø§Ø¯Ù…Ø¬Ù‡Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆØ§Ø±ÙØ¹Ù‡Ù… Ù„Ù€ GitHub.</li>
        </ul>
    </div>
</div>

<script>
// ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function updateInfo() {
    const file = document.getElementById('excelFile').files[0];
    if(file) {
        document.getElementById('fileInfo').innerHTML = `<b>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:</b><br>${file.name}`;
    }
}

async function startSingleConversion() {
    const fileInput = document.getElementById('excelFile');
    const status = document.getElementById('status');
    
    if (fileInput.files.length === 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }

    const file = fileInput.files[0];
    status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø§Ø¨...";
    status.style.color = "#333";
    status.style.background = "#eee";

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø¨Ø´ÙƒÙ„ Ù…Ø±Ù†)
        let hIdx = -1;
        let nameCol = -1;

        for (let i = 0; i < Math.min(rows.length, 20); i++) { // ÙØ­Øµ Ø£ÙˆÙ„ 20 ØµÙ ÙÙ‚Ø· Ù„Ù„Ø³Ø±Ø¹Ø©
            const row = rows[i];
            if (!row) continue;
            for (let j = 0; j < row.length; j++) {
                const cellValue = String(row[j] || "").trim();
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© Ø§Ø³Ù… ÙˆØ·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
                if ((cellValue.includes("Ø§Ø³Ù…") && cellValue.includes("Ø·Ø§Ù„Ø¨")) || cellValue === "Ø§Ù„Ø§Ø³Ù…") {
                    hIdx = i;
                    nameCol = j;
                    break;
                }
            }
            if (hIdx !== -1) break;
        }

        if (hIdx === -1) {
            status.innerHTML = "âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.\nØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© Ù…ÙƒØªÙˆØ¨ ÙÙŠÙ‡Ø§ 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'.";
            status.style.color = "white";
            status.style.background = "#d32f2f";
            return;
        }

        const headers = rows[hIdx];
        const gradeMatch = file.name.match(/(\d+)/);
        const gradeNum = gradeMatch ? gradeMatch[1] : "X";
        const gradeTitle = "Ø§Ù„ØµÙ " + gradeNum;

        // 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const possibleSubjects = [
            "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", 
            "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©", 
            "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ§ØªÙŠØ©", "ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡", "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡","Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©", 
            "Ø§Ù„ÙÙ†ÙˆÙ† Ø§Ù„ØªØ´ÙƒÙŠÙ„ÙŠØ©", "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©", 
        ];

        let subMap = {};
        possibleSubjects.forEach(sub => {
            let col = headers.findIndex(h => String(h || "").includes(sub));
            if (col !== -1) subMap[sub] = col;
        });

        // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        let resultsArray = [];
        for (let i = hIdx + 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row) continue;
            const name = String(row[nameCol] || "").trim();
            
            // Ø´Ø±Ø· Ø§Ù„ØªÙ…ÙŠÙŠØ²: Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø·ÙˆÙŠÙ„Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø­Ø±ÙˆÙ) 
            // ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 3 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            const wordCount = name.split(/\s+/).filter(w => w.length > 0).length;
            
            if (name.length > 10 && wordCount >= 3) {
                let results = {};
                for (let [sub, col] of Object.entries(subMap)) {
                    let score = row[col] || "---";
                    let level = "---";
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯) ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø© Ù„Ù„Ø¯Ø±Ø¬Ø©
                    for (let offset of [-1, 1, -2, 2]) {
                        let nearVal = String(row[col + offset] || "").trim();
                        if (nearVal.length === 1 && /[Ø£-ÙŠ]/.test(nearVal)) {
                            level = nearVal;
                            break;
                        }
                    }
                    results[sub] = { score: score, level: level };
                }
                
                resultsArray.push({
                    name: name,
                    grade: gradeTitle,
                    status: "Ù…Ù‚ÙŠØ¯",
                    results: results
                });
            }
        }

        // 4. ØªÙˆÙ„ÙŠØ¯ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        if(resultsArray.length > 0) {
            const blob = new Blob([JSON.stringify(resultsArray, null, 4)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `results_grade_${gradeNum}.json`;
            a.click();
            
            status.innerHTML = `âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${resultsArray.length} Ø·Ø§Ù„Ø¨ Ù…Ù† ${gradeTitle}.\nØ§ÙØ­Øµ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª (Downloads).`;
            status.style.color = "white";
            status.style.background = "#2e7d32";
        } else {
            status.innerHTML = "âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨.\nØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ ØµÙ 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨' Ù…Ø¨Ø§Ø´Ø±Ø©.";
            status.style.color = "black";
            status.style.background = "#ffa000";
        }

    } catch (error) {
        status.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙ†ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:\n" + error.message;
        status.style.color = "white";
        status.style.background = "#d32f2f";
    }
}
</script>
</body>
</html>
