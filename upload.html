<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .container { background: white; padding: 40px; border-radius: 20px; max-width: 700px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid #0a3d34; }
        .file-box { border: 3px dashed #c5a059; padding: 40px; margin: 25px 0; border-radius: 15px; cursor: pointer; background: #fbfbfb; transition: 0.3s; }
        .file-box:hover { background: #f4ece0; }
        button { background: #0a3d34; color: #c5a059; border: none; padding: 18px 40px; border-radius: 10px; cursor: pointer; font-size: 1.2rem; width: 100%; font-weight: bold; }
        #status { margin-top: 25px; font-weight: bold; padding: 20px; border-radius: 10px; line-height: 1.8; display: none; }
        .log-area { background: #222; color: #0f0; padding: 10px; border-radius: 5px; font-size: 0.8rem; text-align: left; direction: ltr; margin-top: 10px; max-height: 150px; overflow-y: auto; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #0a3d34;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (5-9)</h2>
    <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©</p>
    
    <div class="file-box" onclick="document.getElementById('excelFile').click()">
        <span id="fileInfo">ğŸ“ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù (xls Ø£Ùˆ xlsx)</span>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="updateInfo()">
    </div>
    
    <button onclick="processExcel()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
    
    <div id="status"></div>
    <div id="log" class="log-area"></div>
</div>

<script>
function updateInfo() {
    const file = document.getElementById('excelFile').files[0];
    if(file) document.getElementById('fileInfo').innerHTML = `<b>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:</b><br>${file.name}`;
}

function writeLog(msg) {
    const log = document.getElementById('log');
    log.style.display = "block";
    log.innerHTML += "> " + msg + "<br>";
}

async function processExcel() {
    const fileInput = document.getElementById('excelFile');
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    log.innerHTML = "";
    
    if (fileInput.files.length === 0) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù"); return; }

    status.style.display = "block";
    status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù ØµÙ„Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©...";
    status.style.background = "#eee";

    try {
        const data = await fileInput.files[0].arrayBuffer();
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

        writeLog("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: " + rows.length);

        let nameCol = -1;
        let startRow = -1;

        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø£ÙŠ Ø¹Ù…ÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ/Ø±Ø¨Ø§Ø¹ÙŠ)
        for (let i = 0; i < Math.min(rows.length, 100); i++) {
            for (let j = 0; j < rows[i].length; j++) {
                let cell = String(rows[i][j]).trim();
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª 3 Ø£Ùˆ Ø£ÙƒØ«Ø± ÙˆØ·ÙˆÙ„ Ø§Ù„Ù†Øµ Ø£ÙƒØ«Ø± Ù…Ù† 12
                if (cell.split(/\s+/).length >= 3 && cell.length > 12) {
                    nameCol = j;
                    startRow = i;
                    break;
                }
            }
            if (nameCol !== -1) break;
        }

        if (nameCol === -1) {
            status.innerHTML = "âŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.";
            status.style.background = "#ffdada"; return;
        }

        writeLog("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù…: " + nameCol);

        // ØªØ­Ø¯ÙŠØ¯ ØµÙ Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø¹Ø§Ø¯Ø© ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØµÙ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù€ 2 Ø£Ùˆ 3 ØµÙÙˆÙ)
        let subRow = Math.max(0, startRow - 5);
        let subjectsFound = {};
        const possibleSubs = ["Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©", "ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", "Ø§Ù„ÙÙ†ÙˆÙ† Ø§Ù„Ø¨ØµØ±ÙŠØ©", "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ§ØªÙŠØ©", "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©"];

        // Ù…Ø³Ø­ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
        for (let r = subRow; r < startRow; r++) {
            rows[r].forEach((cell, idx) => {
                possibleSubs.forEach(s => {
                    if (String(cell).includes(s)) subjectsFound[s] = idx;
                });
            });
        }

        let finalStudents = [];
        for (let i = startRow; i < rows.length; i++) {
            let name = String(rows[i][nameCol]).trim();
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            if (name.length > 10 && name.split(/\s+/).length >= 3) {
                let studentResults = {};
                for (let [sub, colIdx] of Object.entries(subjectsFound)) {
                    let score = rows[i][colIdx] || "---";
                    let level = "---";
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø£ØŒ Ø¨ØŒ Ø¬) ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø©
                    for (let off of [-1, 1, -2, 2]) {
                        let v = String(rows[i][colIdx+off]).trim();
                        if (v.length === 1 && "Ø£Ø¨Ø¬Ø¯Ù‡Ù€".includes(v)) { level = v; break; }
                    }
                    studentResults[sub] = { score: score, level: level };
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠØ¯
                let rowStr = rows[i].join(" ");
                let statusText = rowStr.includes("Ù…Ù†Ù‚ÙˆÙ„") ? "Ù…Ù†Ù‚ÙˆÙ„" : "Ù…Ø³ØªØ¬Ø¯";

                finalStudents.push({
                    name: name,
                    grade: fileInput.files[0].name.includes("9") ? "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹" : "Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
                    status: statusText,
                    results: studentResults
                });
            }
        }

        if (finalStudents.length > 0) {
            const blob = new Blob([JSON.stringify(finalStudents, null, 4)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `results_${Date.now()}.json`;
            a.click();
            status.innerHTML = `âœ… Ù†Ø¬Ø§Ø­! Ø§Ø³ØªØ®Ø±Ø¬Ù†Ø§ ${finalStudents.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Ù…Ù„ÙÙƒ.`;
            status.style.background = "#e6ffed";
        } else {
            status.innerHTML = "âš ï¸ Ù„Ù… Ù†Ø¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ ØµØ§Ù„Ø­Ø©.";
        }

    } catch (e) {
        writeLog("Ø®Ø·Ø£: " + e.message);
        status.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙ†ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„.";
    }
}
</script>
</body>
</html>
